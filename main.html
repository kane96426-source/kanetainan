<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å—å¤§é­”æ³•å­¸é™¢ - è–æ®¿</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700&family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --m-navy: #050A18; --m-gold: #D4AF37; --m-crimson: #8E1616; --parchment: #FDF5E6; --btn-crimson: linear-gradient(135deg, #8E1616, #4A0000); }
        body { background-color: var(--m-navy); font-family: 'Noto Serif TC', serif; margin: 0; color: #fff; }
        #canvas { position: fixed; inset: 0; z-index: -1; pointer-events: none; }
        .magic-panel { background: var(--parchment); color: #2A1A14; border: 3px solid var(--m-gold); border-radius: 15px; padding: 25px; background-image: url('https://www.transparenttextures.com/patterns/paper.png'); box-shadow: 0 0 50px rgba(212, 175, 55, 0.3); min-height: 85vh; width: 100%; }
        .artifact-btn { background: var(--btn-crimson); border: 2px solid var(--m-gold); border-radius: 10px; margin: 5px; padding: 15px 5px; font-family: 'Cinzel Decorative'; font-weight: bold; color: var(--m-gold); text-shadow: 1px 1px 3px #000; transition: 0.3s; cursor: pointer; display: flex; flex-direction: column; align-items: center; opacity: 0.9; }
        .artifact-btn.active { opacity: 1; border-width: 3px; box-shadow: 0 0 30px var(--m-crimson); transform: scale(1.05); color: #fff; }
        .cat-btn { background: var(--btn-crimson); color: var(--m-gold); border: 1px solid var(--m-gold); padding: 6px 15px; margin: 3px; border-radius: 5px; font-size: 0.85rem; font-family: 'Cinzel Decorative'; cursor: pointer; }
        .cat-btn.active { background: var(--m-gold); color: #000; }
        .post-card { background: rgba(255,255,255,0.98); border-left: 8px solid var(--m-crimson); padding: 18px; margin-bottom: 20px; border-radius: 8px; color: #2A1A14; position: relative; }
        .tt-input { width: 100%; border: none; background: transparent; text-align: center; font-weight: bold; color: var(--m-crimson); font-size: 0.85rem; }
        #map { height: 650px; border: 5px ridge var(--m-gold); border-radius: 15px; width: 100%; }
        .func-area { display: none; }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>
    <nav class="navbar navbar-dark shadow-sm px-4 sticky-top" style="background:rgba(5,10,24,0.98); border-bottom:2px solid var(--m-gold);">
        <span class="navbar-brand" style="font-family:'Cinzel Decorative';">Magic Academy</span>
        <div class="text-end small"><span id="u-display" class="fw-bold" style="color: var(--m-gold);"></span> | UID: <span id="u-uid" class="text-danger fw-bold"></span> | <span style="cursor:pointer; color:#ff6b6b;" onclick="doLogout()">ç™»å‡º</span></div>
    </nav>

    <div class="container-fluid mt-4 mb-5" style="width: 98%;">
        <div class="row g-2 mb-4 text-center">
            <div class="col-4"><div class="artifact-btn active" id="tab-foodMap" onclick="switchFunc('foodMap')">ğŸ§­ ç¾é£Ÿç¾…ç›¤</div></div>
            <div class="col-4"><div class="artifact-btn" id="tab-timetable" onclick="switchFunc('timetable')">ğŸ“œ é­”æ³•æ™‚ç¨‹</div></div>
            <div class="col-4"><div class="artifact-btn" id="tab-board" onclick="switchFunc('board')">ğŸ”® åŒ¿åå¤§é‡œ</div></div>
        </div>

        <div class="magic-panel">
            <div id="foodMap" class="func-area" style="display:block;"><div id="map"></div></div>
            
            <div id="timetable" class="func-area">
                <div class="row">
                    <div class="col-md-9 border-end border-dark">
                        <h4>é­”æ³•æ™‚ç¨‹è¡¨</h4>
                        <div class="table-responsive"><table class="table table-bordered border-dark text-center align-middle"><thead class="table-dark"><tr><th>ç¯€æ¬¡</th><th>é€±ä¸€</th><th>é€±äºŒ</th><th>é€±ä¸‰</th><th>é€±å››</th><th>é€±äº”</th></tr></thead><tbody id="tt-body"></tbody></table></div>
                        <button class="btn btn-danger w-100 mt-2" onclick="saveTt()">å°å°å­˜æª” (Save)</button>
                    </div>
                    <div class="col-md-3">
                        <h5>ç¾ˆçµ†åå†Š (ç´…ç¶ ç¾è¹¤)</h5><div id="friends-area"></div>
                        <div class="input-group mt-3"><input type="text" id="fuid" class="form-control border-dark" placeholder="UID"><button class="btn btn-dark" onclick="addFriend()">ç°½è¨‚</button></div>
                    </div>
                </div>
            </div>

            <div id="board" class="func-area">
                <div id="category-filters" class="mb-3 text-center border-bottom pb-2">
                    <button class="cat-btn active" onclick="setFilter('å…¨éƒ¨', this)">å…¨éƒ¨</button>
                    <button class="cat-btn" onclick="setFilter('æ„Ÿæƒ…', this)">æ„Ÿæƒ…</button>
                    <button class="cat-btn" onclick="setFilter('ç”Ÿæ´»', this)">ç”Ÿæ´»</button>
                </div>
                <div class="row">
                    <div class="col-md-4">
                        <textarea id="p-text" class="form-control border-dark mb-2" rows="3" placeholder="å‚³éé è¨€..."></textarea>
                        <input type="file" id="p-img" class="form-control border-dark mb-2" accept="image/*"><button class="btn btn-danger w-100" style="background:var(--m-crimson);" onclick="optimizedPost()">æŠ•é€²å¤§é‡œ</button>
                    </div>
                    <div class="col-md-8"><div class="text-end mb-2 small"><span class="badge bg-dark" onclick="setSort('time')">æ–°é è¨€</span> <span class="badge bg-secondary" onclick="setSort('likes')">æœ€é«˜ç†±åº¦</span></div><div id="posts-container"></div></div>
                </div>
            </div>
        </div>
    </div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const API_URL = "ä½ çš„_GAS_éƒ¨ç½²ç¶²å€_exec";
    const user = JSON.parse(sessionStorage.getItem('magic_user'));
    let APP_DATA = null, map = null, currentSort = 'time', currentFilter = 'å…¨éƒ¨';

    window.onload = () => {
        if(!user) { window.location.href = "index.html"; return; }
        document.getElementById('u-display').innerText = user.nickname;
        document.getElementById('u-uid').innerText = user.uid;
        initTable(); fetchAllData(); initP(); draw();
    };

    async function fetchAllData() {
        const response = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: 'getMagicData', uid: user.uid }) });
        APP_DATA = await response.json();
        renderPosts(); renderFriends(); fillTable(APP_DATA.mySched);
    }

    function switchFunc(id) {
        document.querySelectorAll('.func-area').forEach(a => a.style.display='none');
        document.querySelectorAll('.artifact-btn').forEach(l => l.classList.remove('active'));
        document.getElementById(id).style.display='block'; document.getElementById('tab-'+id).classList.add('active');
        if(id==='foodMap') { if(!map) initMap(); setTimeout(()=>map.invalidateSize(), 200); }
    }

    function initMap() {
        map = L.map('map').setView([22.9848, 120.2060], 17);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        const redIcon = new L.Icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png', iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34], shadowSize:[41,41] });
        APP_DATA.restaurants.forEach(s => {
            L.marker([s.lat, s.lng], {icon: redIcon}).addTo(map).bindPopup(`<b>${s.name}</b><br>â­ ${s.stars}<br>${s.addr}`);
        });
    }

    function initTable() {
        let h = ''; for(let i=1; i<=9; i++) { h += `<tr><td class="table-dark small">${i}</td>` + Array(5).fill(0).map((_,j)=>`<td><input id="c-${i}-${j}" class="tt-input"></td>`).join('') + `</tr>`; }
        document.getElementById('tt-body').innerHTML = h;
    }
    function fillTable(d) { if(d) document.querySelectorAll('.tt-input').forEach(i => { if (d[i.id]) i.value = d[i.id]; }); }

    async function saveTt() {
        let d={}; document.querySelectorAll('.tt-input').forEach(i=>d[i.id]=i.value);
        await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: 'saveSched', uid: user.uid, data: d }) });
        alert("æ™‚ç¨‹å·²å°å°");
    }

    function renderFriends() {
        const area = document.getElementById('friends-area'); area.innerHTML = "";
        const h = new Date().getHours(), d = new Date().getDay()-1;
        APP_DATA.friends.forEach(f => {
            const busy = (d>=0 && d<=4) ? (f.sched[`c-${h-7}-${d}`] && f.sched[`c-${h-7}-${d}`].trim()!=="") : false;
            area.innerHTML += `<div class="post-card p-2 mb-1" style="cursor:pointer" onclick="summonFriend('${f.uid}')"><span><b style="color:${busy?'#dc3545':'#198754'}">â—</b> ${f.nick}</span></div>`;
        });
    }

    function renderPosts() {
        let f = APP_DATA.posts.filter(p => currentFilter==='å…¨éƒ¨'||p.cat===currentFilter);
        if(currentSort==='likes') f.sort((a,b)=>b.likes-a.likes); else f.sort((a,b)=>new Date(b.time)-new Date(a.time));
        document.getElementById('posts-container').innerHTML = f.map(p => `
            <div class="post-card p-3 shadow-sm">
                <div class="d-flex justify-content-between small text-muted"><b>[${p.cat}] åŒ¿åå·«å¸«</b><span>${p.time.split('T')[0]}</span></div>
                <p class="mt-2">${p.text}</p>
                <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-outline-dark" onclick="castLike('${p.id}')">âœ¨ è®š <span>${p.likes}</span></button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="this.nextElementSibling.style.display='block'">ğŸ’¬ å›éŸ¿</button>
                    <div style="display:none;" class="mt-2 w-100"><input id="ri-${p.id}" class="form-control form-control-sm mb-1"><button class="btn btn-sm btn-dark" onclick="castReply('${p.id}')">å‚³é</button></div>
                </div>
            </div>`).join('');
    }

    async function castLike(pid) { await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: 'likePost', pid: pid, uid: user.uid }) }); fetchAllData(); }
    async function castReply(pid) { const t = document.getElementById(`ri-${pid}`).value; await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: 'addReply', pid: pid, nick: 'åŒ¿åå·«å¸«', text: t }) }); fetchAllData(); }

    function doLogout() { sessionStorage.removeItem('magic_user'); window.location.href = "index.html"; }
    function setFilter(c, b) { currentFilter=c; document.querySelectorAll('.cat-btn').forEach(t=>t.classList.remove('active')); b.classList.add('active'); renderPosts(); }
    function setSort(s) { currentSort=s; renderPosts(); }

    // ç²’å­å¼•æ“
    const cn=document.getElementById('canvas'), ctx=cn.getContext('2d');
    let pts=[];
    function initP() { cn.width=window.innerWidth; cn.height=window.innerHeight; pts=[]; for(let i=0;i<100;i++) pts.push({x:Math.random()*cn.width, y:Math.random()*cn.height, r:Math.random()*2+1, dy:Math.random()*-0.5, a:Math.random()}); }
    function draw() { ctx.clearRect(0,0,cn.width,cn.height); pts.forEach(p=>{ ctx.beginPath(); ctx.arc(p.x, p.y, p.r, 0, Math.PI*2); ctx.fillStyle=`rgba(212,175,55,${p.a})`; ctx.fill(); p.y+=p.dy; if(p.y<0) p.y=cn.height; }); requestAnimationFrame(draw); }
</script>
</body>
</html>
