<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>å—å¤§é­”æ³•å­¸é™¢ - å²è©©ä¸»é </title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700&family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --m-navy: #050A18; --m-gold: #D4AF37; --m-crimson: #8E1616; --parchment: #FDF5E6; --btn-crimson: linear-gradient(135deg, #8E1616, #4A0000); }
        body { background-color: var(--m-navy); font-family: 'Noto Serif TC', serif; color: #fff; margin: 0; }
        .magic-panel { background: var(--parchment); color: #2A1A14; border: 3px solid var(--m-gold); border-radius: 15px; padding: 30px; background-image: url('https://www.transparenttextures.com/patterns/paper.png'); box-shadow: 0 0 50px rgba(0,0,0,0.5); }
        .artifact-btn { background: var(--btn-crimson); border: 2px solid var(--m-gold); border-radius: 10px; margin: 5px; padding: 15px 5px; font-family: 'Cinzel Decorative'; font-weight: bold; color: var(--m-gold); cursor: pointer; display: flex; flex-direction: column; align-items: center; opacity: 0.9; }
        .artifact-btn.active { opacity: 1; transform: scale(1.05); box-shadow: 0 0 30px var(--m-crimson); color: #fff; }
        .tt-input { width: 100%; border: none; background: transparent; text-align: center; font-weight: bold; color: var(--m-crimson); }
        .post-card { background: rgba(255,255,255,0.95); border-left: 8px solid var(--m-crimson); padding: 20px; margin-bottom: 20px; border-radius: 8px; color: #333; }
        #map { height: 600px; border: 5px ridge var(--m-gold); border-radius: 15px; width: 100%; }
        .func-area { display: none; }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark shadow-sm px-4 sticky-top" style="background:rgba(5,10,24,0.98); border-bottom:2px solid var(--m-gold);">
        <span class="navbar-brand">Magic Academy Guide</span>
        <div class="text-end small"><span id="u-nick" class="fw-bold" style="color:var(--m-gold);"></span> | <span style="cursor:pointer; color:#ff6b6b;" onclick="doLogout()">ç™»å‡º</span></div>
    </nav>

    <div class="container-fluid mt-4" style="width: 98%;">
        <div class="row g-2 mb-4 text-center">
            <div class="col-4"><div class="artifact-btn active" id="tab-foodMap" onclick="switchFunc('foodMap')">ğŸ§­ ç¾é£Ÿç¾…ç›¤</div></div>
            <div class="col-4"><div class="artifact-btn" id="tab-timetable" onclick="switchFunc('timetable')">ğŸ“œ é­”æ³•æ™‚ç¨‹</div></div>
            <div class="col-4"><div class="artifact-btn" id="tab-board" onclick="switchFunc('board')">ğŸ”® åŒ¿åå¤§é‡œ</div></div>
        </div>

        <div class="magic-panel">
            <div id="foodMap" class="func-area" style="display:block;"><div id="map"></div></div>
            
            <div id="timetable" class="func-area">
                <div class="row">
                    <div class="col-md-9 border-end border-dark">
                        <h4>æˆ‘çš„æ™‚ç¨‹ (UID: <span id="u-uid" class="text-danger"></span>)</h4>
                        <table class="table table-bordered border-dark text-center align-middle">
                            <thead class="table-dark"><tr><th>ç¯€æ¬¡</th><th>ä¸€</th><th>äºŒ</th><th>ä¸‰</th><th>å››</th><th>äº”</th></tr></thead>
                            <tbody id="tt-body"></tbody>
                        </table>
                        <button class="btn btn-danger w-100" onclick="saveTt()">å°å°å­˜æª”</button>
                    </div>
                    <div class="col-md-3 mt-4 mt-md-0">
                        <h5>ç¾ˆçµ†åå†Š</h5><div id="friends-list"></div>
                        <input type="text" id="f-uid" class="form-control mt-2" placeholder="å¥½å‹ UID"><button class="btn btn-dark w-100 mt-1" onclick="addFriend()">ç°½è¨‚</button>
                    </div>
                </div>
            </div>

            <div id="board" class="func-area">
                <div class="row">
                    <div class="col-md-4">
                        <h5>ç™¼å¸ƒé è¨€</h5>
                        <textarea id="p-text" class="form-control mb-2" rows="4"></textarea>
                        <select id="p-cat" class="form-select mb-2"><option>æ„Ÿæƒ…</option><option>å­¸æ¥­</option><option>ç”Ÿæ´»</option><option>é–’èŠ</option></select>
                        <button class="btn btn-danger w-100" onclick="sendPost()">æŠ•é€²å¤§é‡œ</button>
                    </div>
                    <div class="col-md-8"><div id="posts-container"></div></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbwaFDlfsrR39Nr882_WkyVqgSeDW64pTwIXKf9_MUV1ZnSvVbM27mOGG6BrKejOWLa_ng/exec";
        const user = JSON.parse(localStorage.getItem('magic_user'));
        let APP_DATA = null, map = null;

        window.onload = async () => {
            if(!user) { window.location.href = "index.html"; return; }
            document.getElementById('u-nick').innerText = user.nickname;
            document.getElementById('u-uid').innerText = user.uid;
            initTable();
            await refreshData();
        };

        async function refreshData() {
            const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'getMagicData', uid: user.uid }) }).then(r => r.json());
            APP_DATA = res;
            renderPosts();
            renderFriends();
            fillTable(res.mySched);
        }

        function switchFunc(id) {
            document.querySelectorAll('.func-area').forEach(a => a.style.display='none');
            document.querySelectorAll('.artifact-btn').forEach(l => l.classList.remove('active'));
            document.getElementById(id).style.display='block';
            document.getElementById('tab-'+id).classList.add('active');
            if(id==='foodMap') { if(!map) initMap(); setTimeout(()=>map.invalidateSize(), 200); }
        }

        function initMap() {
            map = L.map('map').setView([22.9848, 120.2060], 17);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            const redIcon = new L.Icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png', iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34], shadowSize:[41,41] });
            APP_DATA.restaurants.forEach(s => {
                L.marker([s.lat, s.lng], {icon: redIcon}).addTo(map).bindPopup(`<b>${s.name}</b><br>â­ ${s.stars}<br>${s.addr}`);
            });
        }

        function initTable() {
            let h = ''; for(let i=1; i<=9; i++) { h += `<tr><td class="table-dark">${i}</td>` + Array(5).fill(0).map((_,j)=>`<td><input id="c-${i}-${j}" class="tt-input"></td>`).join('') + `</tr>`; }
            document.getElementById('tt-body').innerHTML = h;
        }

        function fillTable(d) { if(d) document.querySelectorAll('.tt-input').forEach(i => { if (d[i.id]) i.value = d[i.id]; }); }

        async function saveTt() {
            let d={}; document.querySelectorAll('.tt-input').forEach(i=>d[i.id]=i.value);
            await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'saveSchedule', uid: user.uid, data: d }) });
            alert("å°å°æˆåŠŸ");
        }

        function renderPosts() {
            document.getElementById('posts-container').innerHTML = APP_DATA.posts.map(p => `
                <div class="post-card shadow-sm">
                    <div class="d-flex justify-content-between small text-muted"><b>[${p.cat}] åŒ¿åå·«å¸«</b><span>${p.time.split(' GMT')[0]}</span></div>
                    <p class="mt-2 mb-1">${p.text}</p>
                    <button class="btn btn-sm btn-outline-dark" onclick="castLike('${p.id}')">âœ¨ è®š ${p.likes}</button>
                    <div class="mt-2 border-top pt-2">
                        ${p.reps.map(r => `<div class="small text-muted">å·«å¸«ï¼š${r.text}</div>`).join('')}
                        <input id="ri-${p.id}" class="form-control form-control-sm mt-1" placeholder="ç•™è¨€...">
                        <button class="btn btn-sm btn-dark mt-1" onclick="castReply('${p.id}')">å‚³éå›éŸ¿</button>
                    </div>
                </div>`).join('');
        }

        async function castLike(pid) {
            await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'likePost', pid, uid: user.uid }) });
            await refreshData();
        }

        async function castReply(pid) {
            const t = document.getElementById(`ri-${pid}`).value;
            await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'addReply', pid, nick: 'åŒ¿åå·«å¸«', text: t }) });
            await refreshData();
        }

        function doLogout() { localStorage.removeItem('magic_user'); window.location.href = "index.html"; }
    </script>
</body>
</html>
