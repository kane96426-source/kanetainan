<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700&family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root { --m-navy: #050A18; --m-gold: #D4AF37; --m-crimson: #8E1616; --parchment: #FDF5E6; --btn-crimson: linear-gradient(135deg, #8E1616, #4A0000); }
    body { background-color: var(--m-navy); font-family: 'Noto Serif TC', serif; margin: 0; color: #fff; overflow-x: hidden; }
    canvas { position: fixed; inset: 0; z-index: -1; pointer-events: none; }
    .magic-panel { background: var(--parchment); color: #2A1A14; border: 3px solid var(--m-gold); border-radius: 15px; box-shadow: 0 0 50px rgba(212, 175, 55, 0.3); padding: 25px; background-image: url('https://www.transparenttextures.com/patterns/paper.png'); min-height: 85vh; width: 100%; }
    .artifact-btn {
      background: var(--btn-crimson); border: 2px solid var(--m-gold); border-radius: 10px; margin: 5px; padding: 15px 5px;
      font-family: 'Cinzel Decorative'; font-weight: bold; color: var(--gold); text-shadow: 1px 1px 3px #000; transition: 0.3s;
      cursor: pointer; display: flex; flex-direction: column; align-items: center; opacity: 0.9;
    }
    .artifact-btn.active { border-width: 3px; box-shadow: 0 0 30px var(--m-crimson); transform: scale(1.05); color: #fff; opacity: 1; }
    .cat-btn { background: var(--btn-crimson); color: var(--m-gold); border: 1px solid var(--m-gold); padding: 6px 15px; margin: 3px; border-radius: 5px; font-size: 0.85rem; font-family: 'Cinzel Decorative'; cursor: pointer; }
    .cat-btn.active { background: var(--m-gold); color: #000; }
    .post-card { background: rgba(255,255,255,0.95); border-left: 8px solid var(--m-crimson); padding: 18px; margin-bottom: 20px; border-radius: 8px; color: #2A1A14; position: relative; }
    .tt-input { width: 100%; border: none; background: transparent; text-align: center; font-weight: bold; color: var(--m-crimson); font-size: 0.85rem; }
    .reply-box { background: rgba(0,0,0,0.06); border-radius: 5px; padding: 10px; margin-top: 10px; border-left: 3px solid var(--m-gold); font-size: 0.85rem; }
    .reply-input { border: none; border-bottom: 1px solid var(--m-gold); background: transparent; width: 100%; font-style: italic; color: #2A1A14; outline: none; }
    #map { height: 600px; border: 5px ridge var(--m-gold); border-radius: 15px; width: 100%; }
  </style>
</head>
<body>
  <canvas id="canvas-main"></canvas>
  <nav class="navbar navbar-dark shadow-sm px-4 sticky-top" style="background:rgba(5,10,24,0.98); border-bottom:2px solid var(--m-gold);">
    <span class="navbar-brand">Magic Academy</span>
    <div class="text-end small"><span id="user-display" class="fw-bold" style="color: var(--m-gold);"></span> | (UID: <span id="nav-uid" class="text-danger fw-bold"></span>) | <span style="cursor:pointer; color:#ff6b6b;" onclick="window.magicLogout()">ç™»å‡º</span></div>
  </nav>

  <div class="container-fluid mt-4 mb-5" style="width: 98%;">
    <div class="row g-2 mb-4 text-center">
      <div class="col-4"><div class="artifact-btn active" id="tab-foodMap" onclick="switchFunc('foodMap')">ğŸ§­ ç¾…ç›¤</div></div>
      <div class="col-4"><div class="artifact-btn" id="tab-timetable" onclick="switchFunc('timetable')">ğŸ“œ æ™‚ç¨‹</div></div>
      <div class="col-4"><div class="artifact-btn" id="tab-board" onclick="switchFunc('board')">ğŸ”® å¤§é‡œ</div></div>
    </div>

    <div class="magic-panel shadow-lg">
      <div id="foodMap" class="func-area active"><div id="map"></div></div>
      <div id="timetable" class="func-area" style="display:none;">
        <div class="row">
          <div class="col-md-8">
            <h4>æˆ‘çš„é­”æ³•æ™‚ç¨‹ (UID: <span id="main-uid" class="text-danger fw-bold"></span>)</h4>
            <div class="table-responsive"><table class="table table-bordered border-dark text-center align-middle"><thead class="table-dark"><tr><th>ç¯€æ¬¡ / æ™‚é–“</th><th>é€±ä¸€</th><th>é€±äºŒ</th><th>é€±ä¸‰</th><th>é€±å››</th><th>é€±äº”</th></tr></thead><tbody id="tt-body"></tbody></table></div>
            <button class="btn btn-danger w-100 mt-2" onclick="saveMyTt()">å°å°å­˜æª” (Save)</button>
          </div>
          <div class="col-md-4 mt-4 mt-md-0">
            <h4>ç¾ˆçµ†åå†Š</h4><div id="friends-list-area"></div>
            <div class="input-group mt-3"><input type="text" id="fuid" class="form-control border-dark" placeholder="UID"><button class="btn btn-dark" onclick="addFriend()">ç°½è¨‚</button></div>
          </div>
        </div>
        <div id="friend-table-area" class="mt-3 p-3 rounded" style="display:none; background:rgba(255,255,255,0.4); border:2px dashed var(--m-gold);"><h5 id="summon-name"></h5><table class="table table-sm table-bordered border-dark text-center" id="f-tt"></table></div>
      </div>
      <div id="board" class="func-area" style="display:none;">
        <div id="category-filters" class="mb-3 text-center border-bottom pb-2">
            <button class="cat-btn active" onclick="setFilter('å…¨éƒ¨', this)">å…¨éƒ¨</button>
            <button class="cat-btn" onclick="setFilter('æ„Ÿæƒ…', this)">æ„Ÿæƒ…</button>
            <button class="cat-btn" onclick="setFilter('å­¸æ¥­', this)">å­¸æ¥­</button>
            <button class="cat-btn" onclick="setFilter('ç”Ÿæ´»', this)">ç”Ÿæ´»</button>
            <button class="cat-btn" onclick="setFilter('é–’èŠ', this)">é–’èŠ</button>
        </div>
        <div class="row">
          <div class="col-md-4">
            <textarea id="p-text" class="form-control border-dark mb-2" rows="3" placeholder="å‚³éé è¨€..."></textarea>
            <select id="p-cat" class="form-select border-dark mb-2"><option value="æ„Ÿæƒ…">æ„Ÿæƒ…</option><option value="å­¸æ¥­">å­¸æ¥­</option><option value="ç”Ÿæ´»">ç”Ÿæ´»</option><option value="é–’èŠ">é–’èŠ</option></select>
            <input type="file" id="p-img" class="form-control border-dark mb-2" accept="image/*"><button class="btn btn-danger w-100" style="background:var(--m-crimson);" id="postBtn" onclick="optimizedPost()">æŠ•é€²å¤§é‡œ</button>
          </div>
          <div class="col-md-8"><div class="text-end mb-2"><button class="btn btn-sm btn-outline-dark" id="btn-time" onclick="setSort('time')">æ–°é è¨€</button><button class="btn btn-sm btn-outline-dark" id="btn-likes" onclick="setSort('likes')">æœ€é«˜ç†±åº¦</button></div><div id="posts-container"></div></div>
        </div>
      </div>
    </div>
  </div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  // ã€æ ¸å¿ƒä¿®å¾©ã€‘å¾ URL æŠ“å–è³‡è¨Šï¼Œé¿é–‹ Iframe æœ¬åœ°å„²å­˜é™åˆ¶
  const urlParams = new URLSearchParams(window.location.search);
  const user = { uid: urlParams.get('uid'), nickname: decodeURIComponent(urlParams.get('nick')) };
  var APP_DATA = null, map = null, currentSort = 'time', currentFilter = 'å…¨éƒ¨';

  (function init() {
    if(!user.uid) { window.top.location.href = "index.html"; return; }
    document.getElementById('user-display').innerText = user.nickname;
    document.getElementById('nav-uid').innerText = user.uid;
    document.getElementById('main-uid').innerText = user.uid;
    initTable();
    google.script.run.withSuccessHandler(res => {
      APP_DATA = res; renderPosts();
      // ã€æ ¸å¿ƒä¿®å¾©ã€‘è‡ªå‹•å›é¡¯æˆ‘çš„æ™‚ç¨‹
      if(res.mySched) document.querySelectorAll('.tt-input').forEach(i => { if (res.mySched[i.id]) i.value = res.mySched[i.id]; });
      renderFriends(); switchFunc('foodMap');
    }).getMagicData(user.uid);
    initPMain(); drawMain();
  })();

  window.magicLogout = function() { localStorage.removeItem('magic_user'); window.top.location.href = "index.html"; };

  function switchFunc(id) {
    document.querySelectorAll('.func-area').forEach(a => a.style.display='none');
    document.querySelectorAll('.artifact-btn').forEach(l => l.classList.remove('active'));
    document.getElementById(id).style.display='block'; document.getElementById('tab-'+id).classList.add('active');
    if(id==='foodMap') { if(!map) initMap(); setTimeout(()=>map.invalidateSize(), 200); }
  }

  // --- åœ°åœ– ---
  function initMap() {
    map = L.map('map').setView([22.9848, 120.2060], 17);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    const redIcon = new L.Icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png', iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34], shadowSize:[41,41] });
    APP_DATA.restaurants.forEach(s => {
      let cms = s.cms.map(c => `<div class="border-bottom small py-1"><b>${c.user}</b>: ${c.text}</div>`).join('');
      let pop = `<div style="width:200px"><h6>${s.name}</h6><div class="text-warning fw-bold">â­ ${s.stars}</div><div class="input-group input-group-sm mt-2"><select id="star-${s.id}" class="form-select"><option value="5">5æ˜Ÿ</option><option value="1">1æ˜Ÿ</option></select><input id="txt-${s.id}" class="form-control" placeholder="è©•åƒ¹..."><button class="btn btn-dark" onclick="window.magicReview('${s.id}')">é€å‡º</button></div><div class="overflow-auto mt-1" id="cms-${s.id}" style="max-height:80px">${cms}</div></div>`;
      L.marker([s.lat, s.lng], {icon: redIcon}).addTo(map).bindPopup(pop);
    });
  }
  window.magicReview = function(id) {
    const s = document.getElementById(`star-${id}`).value, t = document.getElementById(`txt-${id}`).value;
    google.script.run.withSuccessHandler(()=>{location.reload();}).addRestaurantReview(id, user.nickname, s, t);
  };

  function initTable() {
    const times = ["08:00", "09:00", "10:10", "11:10", "13:30", "14:30", "15:40", "16:40", "18:30"];
    let h = ''; for(let i=1; i<=9; i++) { h += `<tr><td class="table-dark small">${i}<br>${times[i-1]}</td>` + Array(5).fill(0).map((_,j)=>`<td><input id="c-${i}-${j}" class="tt-input"></td>`).join('') + `</tr>`; }
    document.getElementById('tt-body').innerHTML = h;
  }
  function saveMyTt() { let d={}; document.querySelectorAll('.tt-input').forEach(i=>d[i.id]=i.value); google.script.run.saveSchedule(user.uid, d); alert("å°å°æˆåŠŸ"); }

  // --- æŒ‰è®šèˆ‡å›è¦†æ ¸å¿ƒä¿®å¾© (100% æˆåŠŸç‡) ---
  window.magicLike = function(pid, b) {
    let s=b.querySelector('span'), cur=parseInt(s.innerText); s.innerText=cur+1;
    google.script.run.withSuccessHandler(res=>{if(res.status==='error')s.innerText=cur;}).likePost(pid, user.uid);
  };
  window.magicReplyMagic = function(pid) {
    const input = document.getElementById(`ri-${pid}`), content = input.value;
    if(!content) return;
    document.getElementById(`rep-list-${pid}`).innerHTML += `<div class="reply-box">å·«å¸«: ${content}</div>`;
    input.value = "";
    google.script.run.addReply(pid, "åŒ¿åå·«å¸«", content);
  };

  function renderFriends() {
    const area = document.getElementById('friends-list-area'); area.innerHTML = "";
    const h = new Date().getHours(), d = new Date().getDay()-1;
    APP_DATA.friends.forEach(f => {
      const busy = (d>=0 && d<=4) ? (f.sched[`c-${h-7}-${d}`] && f.sched[`c-${h-7}-${d}`].trim()!=="") : false;
      area.innerHTML += `<div class="post-card p-2 mb-1" style="cursor:pointer" onclick="summonFriendTable('${f.uid}')"><span><b style="color:${busy?'#dc3545':'#198754'}">â—</b> ${f.nick}</span></div>`;
    });
  }
  function summonFriendTable(fuid) {
    const f = APP_DATA.friends.find(x => x.uid == fuid); document.getElementById('friend-table-area').style.display='block';
    let fhtml='<thead class="table-dark"><tr><th></th><th>ä¸€</th><th>äºŒ</th><th>ä¸‰</th><th>å››</th><th>äº”</th></tr></thead><tbody>';
    for(let i=1; i<=9; i++) { fhtml+=`<tr><td class="fw-bold table-light">${i}</td>`; for(let j=0; j<5; j++) fhtml+=`<td>${f.sched[`c-${i}-${j}`]||''}</td>`; fhtml+='</tr>'; }
    document.getElementById('f-tt').innerHTML=fhtml+'</tbody>';
  }
  function addFriend() { google.script.run.withSuccessHandler(()=>location.reload()).addMagicFriend(user.uid, document.getElementById('fuid').value); }

  function renderPosts() {
    let f = APP_DATA.posts.filter(p => currentFilter==='å…¨éƒ¨'||p.cat===currentFilter);
    if(currentSort==='likes') f.sort((a,b)=>b.likes-a.likes); else f.sort((a,b)=>new Date(b.time)-new Date(a.time));
    document.getElementById('posts-container').innerHTML = f.map(p => `
      <div class="post-card p-3 shadow-sm">
        <div class="d-flex justify-content-between small text-muted"><b>[${p.cat}] åŒ¿åå·«å¸«</b><span>${p.time.split(' GMT')[0]}</span></div>
        <p class="mt-2 mb-1">${p.text}</p>
        ${p.img?`<img src="${p.img}" style="width:100%; border-radius:5px; margin-bottom:10px;">`:''}
        <div class="d-flex gap-2">
          <button class="btn btn-sm btn-outline-dark" onclick="window.magicLike('${p.id}', this)">âœ¨ è®š <span>${p.likes}</span></button>
          <button class="btn btn-sm btn-outline-secondary" onclick="toggleRep('${p.id}')">ğŸ’¬ ${p.reps.length}</button>
        </div>
        <div id="rep-sec-${p.id}" class="mt-2" style="display:none;">
          <div id="rep-list-${p.id}">${p.reps.map(r=>`<div class="reply-box">å·«å¸«: ${r.text}</div>`).join('')}</div>
          <div class="input-group mt-2"><input id="ri-${p.id}" class="reply-input" placeholder="å›å ±è¿´éŸ¿..."><button class="btn btn-sm btn-dark" onclick="window.magicReplyMagic('${p.id}')">å‚³é</button></div>
        </div>
      </div>`).join('');
  }
  function setFilter(c, b) { currentFilter=c; document.querySelectorAll('.cat-btn').forEach(t=>t.classList.remove('active')); b.classList.add('active'); renderPosts(); }
  function setSort(s) { currentSort=s; renderPosts(); }
  function toggleRep(id) { const s=document.getElementById(`rep-sec-${id}`); s.style.display=s.style.display==='none'?'block':'none'; }
  function optimizedPost() {
    const t=document.getElementById('p-text').value, c=document.getElementById('p-cat').value, f=document.getElementById('p-img').files[0];
    if(!t) return;
    const proceed=(b64=null)=>{ APP_DATA.posts.unshift({id:'temp', text:t, cat:c, likes:0, time:new Date().toString(), img:b64, reps:[], nick:user.nickname}); renderPosts(); google.script.run.addPost(user.nickname, t, b64, c); };
    if(f){ const r=new FileReader(); r.onload=(e)=>{
        const img=new Image(); img.src=e.target.result;
        img.onload=()=>{
            const cvs=document.createElement('canvas'); const ctx=cvs.getContext('2d');
            const max_w=400; const scale=max_w/img.width; cvs.width=max_w; cvs.height=img.height*scale;
            ctx.drawImage(img, 0, 0, cvs.width, cvs.height); proceed(cvs.toDataURL('image/jpeg', 0.5));
        }
    }; r.readAsDataURL(f); } else proceed();
  }
  var cnM=document.getElementById('canvas-main'), ctxM=cnM.getContext('2d'), ptsM=[]; function initPMain() { cnM.width=window.innerWidth; cnM.height=window.innerHeight; ptsM=[]; for(let i=0;i<150;i++) ptsM.push({x:Math.random()*cnM.width, y:Math.random()*cnM.height, r:Math.random()*2+1, dy:Math.random()*-0.5, a:Math.random()}); } function drawMain() { ctxM.clearRect(0,0,cnM.width,cnM.height); ptsM.forEach(p=>{ ctx.beginPath(); ctx.arc(p.x, p.y, p.r, 0, Math.PI*2); ctx.fillStyle=`rgba(212,175,55,${p.a})`; ctx.fill(); p.y+=p.dy; if(p.y<0) p.y=cnM.height; }); requestAnimationFrame(drawMain); }
</script>
</body>
</html>
