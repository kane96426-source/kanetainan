<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å—å¤§é­”æ³•å­¸é™¢ - è–æ®¿</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700&family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --m-navy: #050A18; --m-gold: #D4AF37; --m-crimson: #8E1616; --parchment: #FDF5E6; --btn-crimson: linear-gradient(135deg, #8E1616, #4A0000); }
        body { background-color: var(--m-navy); font-family: 'Noto Serif TC', serif; color: #333; margin: 0; }
        .magic-panel { background: var(--parchment); border: 3px solid var(--m-gold); border-radius: 15px; padding: 25px; background-image: url('https://www.transparenttextures.com/patterns/paper.png'); box-shadow: 0 0 50px rgba(0,0,0,0.5); min-height: 85vh; width: 100%; }
        .artifact-btn { background: var(--btn-crimson); border: 2px solid var(--m-gold); border-radius: 10px; margin: 5px; padding: 15px 5px; font-family: 'Cinzel Decorative'; font-weight: bold; color: var(--m-gold); cursor: pointer; display: flex; flex-direction: column; align-items: center; opacity: 0.9; text-shadow: 1px 1px 3px #000; }
        .artifact-btn.active { opacity: 1; transform: scale(1.03); box-shadow: 0 0 30px var(--m-crimson); color: #fff; }
        .cat-btn { background: var(--btn-crimson); color: var(--m-gold); border: 1px solid var(--m-gold); padding: 6px 15px; margin: 3px; border-radius: 5px; font-size: 0.85rem; font-family: 'Cinzel Decorative'; cursor: pointer; text-shadow: 1px 1px 2px #000; }
        .cat-btn.active { background: var(--m-gold); color: #000; text-shadow: none; }
        .tt-input { width: 100%; border: none; background: transparent; text-align: center; font-weight: bold; color: var(--m-crimson); }
        .post-card { background: rgba(255,255,255,0.98); border-left: 8px solid var(--m-crimson); padding: 20px; margin-bottom: 25px; border-radius: 8px; color: #2A1A14; position: relative; }
        #map { height: 650px; border: 5px ridge var(--m-gold); border-radius: 15px; width: 100%; }
        .func-area { display: none; }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark shadow-sm px-4 sticky-top" style="background:rgba(5,10,24,0.98); border-bottom:2px solid var(--m-gold);">
        <span class="navbar-brand" style="font-family:'Cinzel Decorative'; color:var(--m-gold);">Magic Academy</span>
        <div class="text-end small"><span id="u-display" class="fw-bold" style="color:var(--m-gold);"></span> | UID: <span id="u-uid" class="text-danger fw-bold"></span> | <span style="cursor:pointer; color:#ff6b6b;" onclick="location.href='index.html'">ç™»å‡º</span></div>
    </nav>

    <div class="container-fluid mt-4 mb-5" style="width: 98%;">
        <div class="row g-2 mb-4 text-center">
            <div class="col-4" onclick="switchFunc('foodMap', this)"><div class="artifact-btn active">ğŸ§­ ç¾é£Ÿç¾…ç›¤</div></div>
            <div class="col-4" onclick="switchFunc('timetable', this)"><div class="artifact-btn">ğŸ“œ é­”æ³•æ™‚ç¨‹</div></div>
            <div class="col-4" onclick="switchFunc('board', this)"><div class="artifact-btn">ğŸ”® åŒ¿åå¤§é‡œ</div></div>
        </div>

        <div class="magic-panel">
            <div id="foodMap" class="func-area" style="display:block;"><div id="map"></div></div>
            
            <div id="timetable" class="func-area">
                <div class="row">
                    <div class="col-md-9 border-end border-dark">
                        <h4>é­”æ³•æ™‚ç¨‹è¡¨</h4>
                        <div class="table-responsive"><table class="table table-bordered border-dark text-center align-middle"><thead class="table-dark"><tr><th>ç¯€æ¬¡ / æ™‚é–“</th><th>é€±ä¸€</th><th>é€±äºŒ</th><th>é€±ä¸‰</th><th>é€±å››</th><th>é€±äº”</th></tr></thead><tbody id="tt-body"></tbody></table></div>
                        <button class="btn btn-danger w-100 mt-2" onclick="saveTt()">å°å°å­˜æª”</button>
                    </div>
                    <div class="col-md-3"><h5>ç¾ˆçµ†åå†Š</h5><div id="friends-area"></div><div class="input-group mt-3"><input type="text" id="f-uid" class="form-control border-dark" placeholder="UID"><button class="btn btn-dark" onclick="addFriend()">ç°½è¨‚</button></div></div>
                </div>
                <div id="friend-table-area" class="mt-3 p-3 rounded" style="display:none; background:rgba(255,255,255,0.4); border:2px dashed var(--m-gold);"><h5 id="summon-name"></h5><table class="table table-sm table-bordered border-dark text-center" id="f-tt"></table></div>
            </div>

            <div id="board" class="func-area">
                <div id="category-filters" class="mb-3 text-center border-bottom pb-2">
                    <button class="cat-btn active" onclick="setFilter('å…¨éƒ¨', this)">å…¨éƒ¨</button>
                    <button class="cat-btn" onclick="setFilter('æ„Ÿæƒ…', this)">æ„Ÿæƒ…</button>
                    <button class="cat-btn" onclick="setFilter('å­¸æ¥­', this)">å­¸æ¥­</button>
                    <button class="cat-btn" onclick="setFilter('ç”Ÿæ´»', this)">ç”Ÿæ´»</button>
                    <button class="cat-btn" onclick="setFilter('é–’èŠ', this)">é–’èŠ</button>
                </div>
                <div class="row">
                    <div class="col-md-4">
                        <textarea id="p-text" class="form-control border-dark mb-2" rows="3" placeholder="å‚³éé è¨€..."></textarea>
                        <select id="p-cat" class="form-select border-dark mb-2"><option>æ„Ÿæƒ…</option><option>å­¸æ¥­</option><option>ç”Ÿæ´»</option><option>é–’èŠ</option></select>
                        <input type="file" id="p-img" class="form-control border-dark mb-2" accept="image/*"><button class="btn btn-danger w-100" onclick="sendPost()">æŠ•é€²å¤§é‡œ</button>
                    </div>
                    <div class="col-md-8">
                        <div class="text-end mb-2 small">
                            <span class="badge bg-dark p-2" style="cursor:pointer" onclick="setSort('time')">æ–°é è¨€ (Newest)</span> 
                            <span class="badge bg-secondary p-2" style="cursor:pointer" onclick="setSort('likes')">æœ€é«˜ç†±åº¦ (Popular)</span>
                        </div>
                        <div id="posts-container"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbwaFDlfsrR39Nr882_WkyVqgSeDW64pTwIXKf9_MUV1ZnSvVbM27mOGG6BrKejOWLa_ng/exec"; 
    const urlParams = new URLSearchParams(window.location.search);
    const user = { uid: urlParams.get('uid'), nickname: decodeURIComponent(urlParams.get('nick')) };
    let APP_DATA = null, map = null, currentSort = 'time', currentFilter = 'å…¨éƒ¨';

    window.onload = () => {
        if(!user.uid) { window.location.href = "index.html"; return; }
        document.getElementById('u-display').innerText = user.nickname;
        document.getElementById('u-uid').innerText = user.uid;
        initTable(); fetchAllData();
    };

    async function apiFetch(data) { return fetch(API_URL, { method: "POST", body: JSON.stringify(data) }).then(r => r.json()); }

    async function fetchAllData() {
        APP_DATA = await apiFetch({ action: 'getMagicData', uid: user.uid });
        renderPosts(); renderFriends(); 
        if(APP_DATA.mySched) Object.keys(APP_DATA.mySched).forEach(k => { if(document.getElementById(k)) document.getElementById(k).value = APP_DATA.mySched[k]; });
        if(map) refreshMarkers();
    }

    // --- æ ¸å¿ƒä¿®æ­£ï¼šæ’åºåŠŸèƒ½ ---
    function setSort(s) {
        currentSort = s;
        // è¦–è¦ºæ¨™é¥‹
        document.querySelectorAll('.badge').forEach(b => b.classList.replace('bg-dark', 'bg-secondary'));
        event.target.classList.replace('bg-secondary', 'bg-dark');
        renderPosts();
    }

    function renderPosts() {
        let f = APP_DATA.posts.filter(p => currentFilter==='å…¨éƒ¨'||p.cat===currentFilter);
        
        // ã€é—œéµã€‘æœ€æ–°çš„è¦åœ¨æœ€ä¸Šé¢
        if(currentSort==='time') {
            f.sort((a,b) => new Date(b.time) - new Date(a.time));
        } else {
            f.sort((a,b) => b.likes - a.likes);
        }

        document.getElementById('posts-container').innerHTML = f.map(p => `
            <div class="post-card shadow-sm p-3">
                <div class="d-flex justify-content-between small text-muted"><b>[${p.cat}] åŒ¿åå·«å¸«</b><span>${new Date(p.time).toLocaleString()} ${p.nick===user.nickname?`<small class="text-danger" style="cursor:pointer" onclick="window.magicDeletePost('${p.id}')">[æ¶ˆæ»…]</small>`:''}</span></div>
                <p class="mt-2 mb-1" style="font-size:1.1rem">${p.text}</p>
                ${p.img?`<img src="${p.img}" class="img-fluid rounded border mb-2 shadow" style="max-height:250px">`:''}
                <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-outline-dark" onclick="window.magicLike('${p.id}', this)">âœ¨ è®š <span>${p.likes}</span></button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="this.nextElementSibling.style.display='block'">ğŸ’¬ è¿´éŸ¿ (${p.reps.length})</button>
                    <div style="display:none;" class="mt-2 w-100">
                        <div id="rep-list-${p.id}">${p.reps.map(r=>`<div class="reply-box">å·«å¸«: ${r.text}</div>`).join('')}</div>
                        <div class="input-group input-group-sm mt-2"><input id="ri-${p.id}" class="form-control"><button class="btn btn-dark" onclick="window.magicReply('${p.id}')">å‚³</button></div>
                    </div>
                </div>
            </div>`).join('');
    }

    // (å…¶é¤˜ switchFunc, initMap, refreshMarkers, initTable, saveTt, addFriend, summonFriend, sendPost, magicReview... å»¶ç”¨ä¸Šä¸€ç‰ˆ)
    function switchFunc(id, btn) { document.querySelectorAll('.func-area').forEach(a => a.style.display='none'); document.querySelectorAll('.artifact-btn').forEach(l => l.classList.remove('active')); document.getElementById(id).style.display='block'; if(btn) btn.querySelector('.artifact-btn').classList.add('active'); if(id==='foodMap') { if(!map) initMap(); setTimeout(()=>map.invalidateSize(), 200); } }
    function initMap() { map = L.map('map').setView([22.9848, 120.2060], 17); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map); refreshMarkers(); }
    function refreshMarkers() { const redIcon = new L.Icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png', iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34], shadowSize:[41,41] }); map.eachLayer(l=>{if(l instanceof L.Marker)map.removeLayer(l)}); APP_DATA.restaurants.forEach(s => { let cms = s.cms.map(c => `<div class="border-bottom small py-1"><b>${c.user}</b>: ${c.text} ${c.user===user.nickname?`<small class="text-danger" style="cursor:pointer" onclick="window.magicDelReview('${s.id}','${c.time}')">[æ¶ˆæ»…]</small>`:''}</div>`).join(''); let pop = `<div style="width:200px"><h6>${s.name}</h6><div class="text-warning fw-bold">â­ ${s.stars}</div><small>${s.addr}</small><div class="input-group input-group-sm mt-2"><select id="star-${s.id}" class="form-select"><option value="5">5æ˜Ÿ</option><option value="4">4æ˜Ÿ</option><option value="3">3æ˜Ÿ</option><option value="2">2æ˜Ÿ</option><option value="1">1æ˜Ÿ</option></select><input id="txt-${s.id}" class="form-control" placeholder="è©•åƒ¹..."><button class="btn btn-dark" onclick="window.magicAddReview('${s.id}')">é€å‡º</button></div><div class="overflow-auto mt-1" style="max-height:80px">${cms}</div></div>`; L.marker([s.lat, s.lng], {icon: redIcon}).addTo(map).bindPopup(pop); }); }
    window.magicAddReview = async (id) => { const s = document.getElementById(`star-${id}`).value, t = document.getElementById(`txt-${id}`).value; if(!t) return; await apiFetch({ action: 'addReview', sid: id, nick: user.nickname, s, t }); fetchAllData(); };
    window.magicDelReview = async (sid, ts) => { if(confirm("æ¶ˆæ»…å›æ†¶ï¼Ÿ")) { await apiFetch({ action: 'delReview', sid, nick: user.nickname, ts }); fetchAllData(); } };
    function initTable() { const times = ["08:00", "09:00", "10:10", "11:10", "13:30", "14:30", "15:40", "16:40", "18:30"]; let h = ''; for(let i=1; i<=9; i++) { h += `<tr><td class="table-dark small">${i}<br>${times[i-1]}</td>` + Array(5).fill(0).map((_,j)=>`<td><input id="c-${i}-${j}" class="tt-input"></td>`).join('') + `</tr>`; } document.getElementById('tt-body').innerHTML = h; }
    async function saveTt() { let d={}; document.querySelectorAll('.tt-input').forEach(i=>d[i.id]=i.value); await apiFetch({ action: 'saveSched', uid: user.uid, data: d }); alert("å°å°æˆåŠŸ"); }
    function renderFriends() { const area = document.getElementById('friends-area'); area.innerHTML = ""; const h = new Date().getHours(), m = new Date().getMinutes(), t = h * 60 + m, d = new Date().getDay()-1; let slot = -1; if (t >= 480 && t < 540) slot = 1; else if (t >= 550 && t < 610) slot = 2; else if (t >= 620 && t < 680) slot = 3; else if (t >= 690 && t < 750) slot = 4; else if (t >= 810 && t < 870) slot = 5; else if (t >= 880 && t < 940) slot = 6; else if (t >= 950 && t < 1010) slot = 7; else if (t >= 1020 && t < 1080) slot = 8; else if (t >= 1110) slot = 9; APP_DATA.friends.forEach(f => { const busy = (d >= 0 && d <= 4 && slot !== -1) ? (f.sched[`c-${slot}-${d}`] && f.sched[`c-${slot}-${d}`].trim() !== "") : false; area.innerHTML += `<div class="post-card p-2 mb-1" style="cursor:pointer; border-left:4px solid ${busy?'#dc3545':'#198754'};" onclick="summonFriend('${f.uid}')"><span><b style="color:${busy?'#dc3545':'#198754'}">â—</b> ${f.nick}</span></div>`; }); }
    function summonFriend(fuid) { const f = APP_DATA.friends.find(x => x.uid == fuid); if(!f) return; document.getElementById('friend-table-area').style.display='block'; document.getElementById('summon-name').innerText = f.nick; let fhtml = '<thead class="table-dark"><tr><th>ç¯€æ¬¡</th><th>ä¸€</th><th>äºŒ</th><th>ä¸‰</th><th>å››</th><th>äº”</th></tr></thead><tbody>'; for(let i=1; i<=9; i++) { fhtml += `<tr><td class="fw-bold table-light">${i}</td>`; for(let j=0; j<5; j++) fhtml += `<td style="font-size:0.75rem">${f.sched[`c-${i}-${j}`] || ""}</td>`; fhtml += '</tr>'; } document.getElementById('f-tt').innerHTML = fhtml + '</tbody>'; }
    async function addFriend() { await apiFetch({ action: 'addFriend', my: user.uid, f: document.getElementById('f-uid').value }); fetchAllData(); }
    function setFilter(c, b) { currentFilter=c; document.querySelectorAll('.cat-btn').forEach(t=>t.classList.remove('active')); b.classList.add('active'); renderPosts(); }
    async function sendPost() { const t=document.getElementById('p-text').value, c=document.getElementById('p-cat').value, f=document.getElementById('p-img').files[0]; if(!t) return; const proceed = async (b64=null) => { await apiFetch({ action: 'addPost', nick: user.nickname, text: t, img: b64, cat: c }); document.getElementById('p-text').value=""; fetchAllData(); }; if(f){ const r=new FileReader(); r.onload=(e)=>{ const img=new Image(); img.src=e.target.result; img.onload=()=>{ const cvs=document.createElement('canvas'); const ctx=cvs.getContext('2d'); const max_w=400; const scale=max_w/img.width; cvs.width=max_w; cvs.height=img.height*scale; ctx.drawImage(img, 0, 0, cvs.width, cvs.height); proceed(cvs.toDataURL('image/jpeg', 0.5)); } }; r.readAsDataURL(f); } else proceed(); }
    window.magicLike = async (pid, b) => { const s = b.querySelector('span'), cur = parseInt(s.innerText); s.innerText = cur+1; await apiFetch({ action: 'likePost', pid, uid: user.uid }); };
    window.magicReply = async (pid) => { const i = document.getElementById(`ri-${pid}`), c = i.value; if(!c) return; await apiFetch({ action: 'addReply', pid, nick: 'åŒ¿åå·«å¸«', text: c }); fetchAllData(); };
    window.magicDeletePost = async (pid) => { if(confirm("æ¶ˆæ»…ï¼Ÿ")) { await apiFetch({ action: 'delPost', pid, nick: user.nickname }); fetchAllData(); } };
</script>
</body>
</html>
