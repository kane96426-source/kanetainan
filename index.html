<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>南大魔法學院 - 入口</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700&family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --m-navy: #050A18; --m-gold: #D4AF37; --m-crimson: #8E1616; --parchment: #FDF5E6; }
        body { background-color: var(--m-navy); font-family: 'Noto Serif TC', serif; height: 100vh; display: flex; align-items: center; margin: 0; overflow: hidden; }
        .magic-panel { background: var(--parchment); color: #2A1A14; border: 3px solid var(--m-gold); border-radius: 15px; box-shadow: 0 0 50px rgba(212, 175, 55, 0.3); padding: 40px; background-image: url('https://www.transparenttextures.com/patterns/paper.png'); width: 90%; max-width: 420px; margin: auto; text-align: center; }
        h1 { font-family: 'Cinzel Decorative', cursive; color: var(--m-gold); text-shadow: 0 0 10px rgba(212, 175, 55, 0.8); }
        .btn-magic { background: linear-gradient(135deg, #8E1616, #4A0000); color: var(--m-gold); border: 1px solid var(--m-gold); font-family: 'Cinzel Decorative'; font-weight: bold; padding: 12px; }
        .btn-magic:disabled { opacity: 0.5; cursor: not-allowed; }
    </style>
</head>
<body>
    <div class="magic-panel">
        <h1>Academy Portal</h1>
        <hr style="border-color: var(--m-gold);">
        <div id="login-box">
            <input type="text" id="u" class="form-control mb-3" placeholder="學員編號">
            <input type="password" id="p" class="form-control mb-2" placeholder="咒語">
            <div class="mb-4 text-start small"><input type="checkbox" onclick="document.getElementById('p').type=this.checked?'text':'password'"> 顯示密碼</div>
            <button class="btn btn-magic w-100" id="loginBtn" onclick="doLogin()">進入學院 (Login)</button>
            <button class="btn btn-link mt-3 text-dark small w-100" onclick="toggleAuth(true)">申請入學契約</button>
        </div>
        <div id="reg-box" style="display:none;">
            <input type="text" id="ru" class="form-control mb-3" placeholder="設定新編號">
            <input type="password" id="rp" class="form-control mb-3" placeholder="設定密碼">
            <input type="text" id="rn" class="form-control mb-3" placeholder="暱稱">
            <button class="btn btn-success w-100 py-3" onclick="doReg()">簽署契約</button>
            <button class="btn btn-link mt-2 text-dark w-100" onclick="toggleAuth(false)">返回</button>
        </div>
    </div>

    <script>
        // ⚠️ 請填入你部署後的 GAS 網址
        const API_URL = "你的_GAS_部署網址_exec";

        function toggleAuth(s) { document.getElementById('login-box').style.display=s?'none':'block'; document.getElementById('reg-box').style.display=s?'block':'none'; }

        async function doLogin() {
            const u = document.getElementById('u').value, p = document.getElementById('p').value, btn = document.getElementById('loginBtn');
            if(!u || !p) return alert("請填齊資料");
            btn.innerText = "驗證中..."; btn.disabled = true;

            try {
                const response = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: 'login', u: u.trim(), p: p.trim() }) });
                const res = await response.json();
                if(res.status === "success") {
                    sessionStorage.setItem('magic_user', JSON.stringify(res));
                    window.location.href = "main.html"; // 跳轉 GitHub 的 main.html
                } else { alert("驗證失敗"); btn.innerText = "進入學院"; btn.disabled = false; }
            } catch(e) { alert("連結魔法網失敗"); btn.disabled = false; }
        }

        async function doReg() {
            const ru=document.getElementById('ru').value, rp=document.getElementById('rp').value, rn=document.getElementById('rn').value;
            const response = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: 'register', u: ru, p: rp, n: rn }) });
            const res = await response.json();
            alert(res.msg || res.status); toggleAuth(false);
        }
    </script>
</body>
</html>
